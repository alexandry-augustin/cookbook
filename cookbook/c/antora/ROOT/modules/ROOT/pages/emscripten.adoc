= Emscripten
:url-wiki: https://en.wikipedia.org/wiki/Emscripten
:url-website: https://emscripten.org/
:url-repo: https://github.com/emscripten-core/emscripten

{url-wiki}[[wiki\]]
{url-website}[[website\]]
{url-repo}[[repo\]]

[,Gemini]
____
Emscripten takes C/C++ code and compiles it to WebAssembly (Wasm) along with necessary JavaScript "glue code" to handle I/O, memory management, and function calls between Wasm and the JS environment.

It offers near-native execution speed, is highly secure (runs in the browser's sandbox), and is now supported by all major web browsers. 
____

== Installation

[,bash]
----
# Get the emsdk repo
git clone git@github.com:emscripten-core/emsdk.git

# Enter that directory
cd emsdk

# Fetch the latest version of the emsdk (not needed the first time you clone)
git pull

# Download and install the latest SDK tools.
./emsdk install latest

# Make the "latest" SDK "active" for the current user. (writes .emscripten file)
./emsdk activate latest

# Activate PATH and other environment variables in the current terminal
# source ./emsdk_env.sh
source ./emsdk_env.fish
----

[NOTE]
====
[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
`git pull` will fetch the current list of tags, but very recent ones may not yet be present there. You can run `./emsdk update-tags` to update the list of tags directly.
____
====

[NOTE]
====
[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
Emsdk does not install any tools to the system, or otherwise interact with Linux package managers. All file changes are done inside the `emsdk/` directory.
____
====

[NOTE]
====
[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
Python is not provided by emsdk. The user is expected to install this beforehand with the system package manager:

[,bash]
----
# Install Python
sudo apt-get install python3

# Install CMake (optional, only needed for tests and building Binaryen or LLVM)
sudo apt-get install cmake
----
____
====

[NOTE]
====
[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
If you want to use your system’s Node.js instead of the emsdk’s, it may be `node` instead of `nodejs`, and you can adjust the `NODE_JS` attribute of your `.emscripten` file to point to it.
____
====

== Updating the SDK

[,bash]
----
# Fetch the latest registry of available tools.
./emsdk update

# Download and install the latest SDK tools.
./emsdk install latest

# Set up the compiler configuration to point to the "latest" SDK.
./emsdk activate latest

# Activate PATH and other environment variables in the current terminal
# source ./emsdk_env.sh
source ./emsdk_env.fish
----

== Emscripten SDK (`emsdk`)

== Emscripten Compiler Frontend (`emcc`)

[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
Emscripten is accessed using the Emscripten Compiler Frontend (`emcc`).
This script invokes all the other tools needed to build your code, and can act as a drop-in replacement for a standard compiler like gcc or clang. 
It is called on the command line using `./emcc` or `./em++`.
____

[,bash]
----
emcc -v
----

== Tutorial

[,c,title="main.c"]
----
#include <stdio.h>

int main() {
  printf("hello, world!\n");
  return 0;
}
----

[,bash]
----
emcc main.c
----

You should see two files generated by that command: `a.out.js` and `a.out.wasm`. 

You can run them using node.js:

[,bash]
----
node a.out.js
----

Emscripten can also generate HTML for testing embedded JavaScript. 

To generate HTML, use the -o (output) command and specify an html file as the target file:

[,bash]
----
emcc main.c -o index.html
----

[NOTE]
====
[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
Unfortunately, several browsers (including Chrome and Safari) do not support `file://` XHR requests, and can’t load extra files needed by the HTML (like a `.wasm` file, or packaged file data as mentioned lower down). 
For these browsers, you’ll need to serve the files using a local webserver and then open `http://localhost:8000/index.html`.
____

[,bash]
----
python -m http.server
----
====

[,https://emscripten.org/docs/getting_started/downloads.html#platform-notes-installation-instructions-sdk]
____
The HTML output isn’t limited just to just displaying text. 
You can also use the SDL API to show a colored cube in a `<canvas>` element (on browsers that support it).
____

[,c,title="main.c"]
----
#include <stdio.h>
#include <SDL/SDL.h>

#ifdef __EMSCRIPTEN__
#include <emscripten.h>
#endif

int main(int argc, char** argv) {
  printf("hello, world!\n");

  SDL_Init(SDL_INIT_VIDEO);
  SDL_Surface *screen = SDL_SetVideoMode(256, 256, 32, SDL_SWSURFACE);

#ifdef TEST_SDL_LOCK_OPTS
  EM_ASM("SDL.defaults.copyOnLock = false; SDL.defaults.discardOnLock = true; SDL.defaults.opaqueFrontBuffer = false;");
#endif

  if (SDL_MUSTLOCK(screen)) SDL_LockSurface(screen);
  for (int i = 0; i < 256; i++) {
    for (int j = 0; j < 256; j++) {
#ifdef TEST_SDL_LOCK_OPTS
      // Alpha behaves like in the browser, so write proper opaque pixels.
      int alpha = 255;
#else
      // To emulate native behavior with blitting to screen, alpha component is ignored. Test that it is so by outputting
      // data (and testing that it does get discarded)
      int alpha = (i+j) % 255;
#endif
      *((Uint32*)screen->pixels + i * 256 + j) = SDL_MapRGBA(screen->format, i, j, 255-i, alpha);
    }
  }
  if (SDL_MUSTLOCK(screen)) SDL_UnlockSurface(screen);
  SDL_Flip(screen);

  printf("you should see a smoothly-colored square - no sharp lines but the square borders!\n");
  printf("and here is some text that should be HTML-friendly: amp: |&| double-quote: |\"| quote: |'| less-than, greater-than, html-like tags: |<cheez></cheez>|\nanother line.\n");

  SDL_Quit();

  return 0;
}
----

[,bash]
----
emcc main.c -o index.html
----